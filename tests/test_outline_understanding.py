"""
测试大纲理解功能
"""

import tkinter as tk
from ui.outline_understanding_window import OutlineUnderstandingWindow
import os

def test_outline_understanding():
    """测试大纲理解功能"""
    # 创建一个测试项目目录
    test_project_path = os.path.join(os.getcwd(), 'test_project')
    os.makedirs(test_project_path, exist_ok=True)
    
    # 创建测试数据库
    import sqlite3
    test_db_path = os.path.join(test_project_path, 'project.db')
    conn = sqlite3.connect(test_db_path)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS outline_understanding (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            input_content TEXT,
            analysis_result TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    conn.commit()
    conn.close()
    
    # 创建大纲理解窗口
    root = tk.Tk()
    root.withdraw()  # 隐藏主窗口
    
    app = OutlineUnderstandingWindow(test_project_path)
    
    # 模拟输入故事文本
    sample_story = """深夜，一个女孩来到一家甜品店，点了一份甜品套餐。身旁的一位男士向她介绍着这份套餐里各个甜品名称的含义，女孩沉浸在甜品的故事里，转头发现刚才的男士不见了。她没多想，准备享用美食。突然她盘子里的一块甜品上出现了一些灰尘，她小心地擦去灰尘，接着整盘甜品都变成灰尘飘散掉。她转过头一看，一位女店员也变成灰尘飘散掉。整个店里只剩下目瞪口呆的女孩一人。这时，这家甜品店开始地动山摇，女孩也晕了过去。

她醒来后发现自己身处一栋烂尾楼的一间房间里。她想要走出房间，却无论如何也走不出去，总被无形的墙给弹回来。她尝试着回忆事情的来龙去脉，却什么都想不起来，就连自己是谁都不知道，只能在脑海中看到一个模糊的装饰物。被困在房间里的她开始疯狂的拍打四周墙壁，想要找到一丝线索，可是却徒劳无功。在她即将崩溃时，房间门外传来了一个男人的声音。虽然男人的声音好像就在门外，可是门外却看不到人影，她也走不出这间房。女孩以为自己是被这个男人绑架了，怀疑他是用了某些科技手段打造了一堵看不见的空气墙以束缚住她。在男人的一番解释后，女孩放下戒心，和这个男人聊了起来。原来男人也和她一样失忆且被困于此，而且已经被困有一段时间。为了方便沟通，两人还给各自取了一个别名，女孩叫小章鱼，男人叫小乌龟。小乌龟还讲述了此地的神奇之处：这里与世隔绝，永远没有黑夜，只有无尽的白昼。而且身处此地，永远不会感到饥饿和疲劳，好像时间停滞了一样。

小章鱼就在房间内聆听着小乌龟描述着这里的一切，却看不到他。小乌龟表示小章鱼过几天就会适应这里的环境，到那时就能走出这间房。几天后，小章鱼果然走出了房间，她看到房间门外就是烂尾楼狭长的过道，过道两边都是各个房间。她还看到走廊上出现了另一个自己，原来那只是她看到的幻象。小乌龟终于在幻象之后现身，他告诉小章鱼说刚走出房间看到一些幻象是正常的，这里有太多解释不了的现象。小乌龟带着小章鱼漫步在烂尾楼中，详细介绍着这里的一切。虽然走出了房间，但是却走不出这栋烂尾楼，好像这栋楼的四周都被无形的墙包围着。另外，无论他们如何上下楼梯，他们也永远无法离开所在的楼层。小乌龟提出了各种猜想，平行宇宙，四维空间，海市蜃楼幻境等。甚至怀疑自己是否是真实存在的生命体。

永远不会天黑的烂尾楼突然被黑夜光临，也许小章鱼的出现使这里发生了变化。两人在黑夜里相拥，擦出爱的火花。熟睡后的小乌龟却很难叫醒，醒来后还伴随着短暂的痛苦，似乎小乌龟也变得不寻常。远处隐约传来女人的哭泣声，两人为了解开疑惑，决定找到这个哭泣的女人，也许她也和他们一样失忆来到了这里。小章鱼和小乌龟走遍一个个房间，终于在一个房间里找到了一个疯疯癫癫的女人。这个女人好像精神失常一样，拉着小章鱼就要小章鱼把孩子还给她，疯女人认为是小章鱼抢走了她的孩子。小乌龟和小章鱼安抚好疯女人之后，决定等她平静一下再和她沟通。可是没过多久，烂尾楼的天空又变回了白昼，疯女人也消失不见。这期间，小章鱼依然会不定时在脑海中浮现出那个装饰物的样子。

他们开始猜测，疯女人的突然出现和消失，一定是离开这栋神奇烂尾楼的关键所在。他们开始寻找线索，希望早点走出去。可是一切的努力都是徒劳的，他们没有找到任何线索。失落的两人畅想着回到现实世界后的生活，憧憬着美好未来。突然，远处传来了歌声，两人前去一探究竟，果然看到了正在歌唱的歌手，随后歌手消失不见。原来这是他们同时看到了相同的幻象。

不久后，楼上又传来异常的声音，为了找出线索，两人这次成功上到了永远上不去的楼层。期间，小乌龟再次出现了不明的痛苦感。痛苦感过后，他们找到了发出奇异声响的房间。只见房间内一个男人在地上画满了各种看不懂的符号。这个神秘男告诉他们说自己已经在此很久了，神秘男认为之所以彼此之前没有遇见，是因为不同楼层所在的空间是不同的。因为黑夜的降临，导致空间重叠，这才遇见。神秘男还说，只有不放弃生的希望，才能走出烂尾楼，回到现实世界。神秘男还给了小章鱼一件红色连衣裙，给了小乌龟一个锦囊。之后，神秘男人就微笑着消失在两人眼前。

小乌龟打开神秘男给的锦囊不久后，就表现得非常怪异，感觉非常痛苦，接着身体就变成灰尘，飘散在哭成泪人的小章鱼眼前。烂尾楼里只剩下小章鱼一个人，她要找到小乌龟，她不想离开他。因为在这栋神奇烂尾楼里，她已经深深地爱上了小乌龟。孤独而又痛苦的小章鱼穿上神秘男送的红色连衣裙，漂浮在空中，眼角留下眼泪。此时耳边传来一个召唤她的声音，一直喊着"留下来，留下来"。她头发飘逸着，双手自然下垂，浮在空中非常凄美。接着她的身体慢慢化作灰尘飘散掉。

与此同时，小乌龟在现实世界中的重症监护室里，握着小章鱼的双手，喊着留下来，留下来。他不想在虚幻中失去小章鱼，更不想在现实中也失去小章鱼。最终，小章鱼醒了过来。原来，虚幻世界里的小乌龟，就是小章鱼现实世界中的丈夫。他们是同一个人！他们是因为在开车途中发生争吵，甚至提及离婚，两人情绪激动，导致车祸发生而陷入昏迷，潜意识才来到了神奇烂尾楼里。小章鱼在烂尾楼里总能在脑海中看到的那个模糊装饰物，正是车内的实际装饰物。而烂尾楼里出现的疯女人是同一个医院病人，因难产而陷入昏迷。至于那个引导他们走出神奇烂尾楼的神秘男，正是小章鱼的主治医生。

主治医生告诉他们，医院联合一家科技公司开发了脑机唤醒系统，将陷入昏迷的病人大脑与电脑相连，病人的潜意识就会进入电脑搭建的虚幻场景中。因为在梦中，时间流逝会非常慢，所以他们感觉过了很多年。但是在那样的虚幻场景中，只有不放弃生的希望，才能在现实中被真正唤醒。这种发明专用于植物人，除了身体上的治疗，更重要的是潜意识方面的治疗。而这种系统，就是最好的唤醒机器，只有潜意识体会到生命的可贵，才能增加被唤醒的几率。之所以小乌龟比小章鱼提前到达烂尾楼，那是因为小乌龟比小章鱼提前连接脑机唤醒系统。至于他们在烂尾楼看到的幻象，都是脑机唤醒系统创造出来的。

两人康复出院后，享受着浪漫假期，这就是他们被困烂尾楼时所憧憬的场景。他们来到这家现实中的甜品店里享用美食，小章鱼感觉这家甜品店似曾相识，一位男服务员也很面熟，好像曾经见过一样。其实他就是之前向小章鱼介绍甜品名称含义的那位男士，只是小章鱼并不记得。小乌龟叫她不要多想，那只是昏迷后的一场梦罢了。当他们走出甜品店后，甜品店飘散成灰尘，一切再次重演，里面留下一个不知所措的女孩，预示着一个新的梦境即将开始。

在那家科技公司，那位之前的在甜品店出现了两次的神秘男人，正是科技公司的操作员，他向上级汇报，新的病人已接收，脑机已连接，正在引导病人进入虚幻场景。"""
    
    # 在文本框中插入测试故事
    app.text_input.insert("1.0", sample_story)
    
    # 模拟设置API密钥
    app.api_key = "sk-5c447dcdbfdc45319954695e45179a29"
    
    # 运行AI分析
    app.run_ai_analysis()
    
    # 由于分析是异步的，我们需要等待一段时间让分析完成
    def check_and_save():
        # 保存分析结果
        app.save_outline_data()
        print("大纲理解功能测试完成！")
        root.destroy()
    
    # 3秒后执行保存
    root.after(3000, check_and_save)
    
    # 启动GUI事件循环
    root.mainloop()

if __name__ == "__main__":
    test_outline_understanding()